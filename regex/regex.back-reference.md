정규 표현식 - 역참조(back reference)
http://sweeper.egloos.com/3064730

```
1. 역참조의 필요성

"정규 표현식 - 하위 표현식"에서 하위 표현식의 중요한 사용법이 하나 더 있다고 하였다.
그게 바로 이 문서에서 소개할 역참조 기능이다.

역참조에 대해 본격적으로 설명하기에 앞서, 이 녀석이 언제 필요할지 보여주는 예제를 하나 살펴보자.

HTML 개발자는 웹 페이지에서 헤더 텍스트를 정의하고 만들고자, 헤더 태그를 사용한다.
헤더 태그는 <H1>~<H5>까지 있으며, 각각 대응되는 종료 태그 </H1>~</H5>를 함께 사용한다.
단계에 관계없이 시작/종료 태그가 일치하는 헤더를 모두 찾아보도록 하자.

[예문]
<BODY>
<H1>Welcome to my homepage</H1>
Content is divided into four sections:<BR>
<H2>C/C++</H2>
<H3>C#, Python, Lua</H3>
<H4>MSSQL, MySQL, SQLite</H3>
<H5>Unreal Engine3</H5>
1.4 years career for UE3
</BODY>

[정규 표현식]
\<H[1-5]\>.*?\<\/H[1-5]\>

[결과]
<BODY>
<H1>Welcome to my homepage</H1>
Content is divided into four sections:<BR>
<H2>C/C++</H2>
<H3>C#, Python, Lua</H3>
<H4>MSSQL, MySQL, SQLite</H3>
<H5>Unreal Engine3</H5>
1.4 years career for UE3
</BODY>

얼레? 얼추 맞는듯 한데, 자세히 살펴보니 <H4>로 시작하는 헤더가 </H3>으로 끝났다.
즉, 잘못된 헤더 태그가 발견된 것인데, 위에서 사용했던 정규 표현식으로는 이를 검출해 낼 방법이 없다.
종료 태그가 일치할 때, 시작 태그가 어떤 텍스트인지 알 수 있는 방법이 없는 것이다.

이런 경우 역참조가 매우 유용해지니 다음 챕터를 제대로 이해하기 바란다.


2. 역참조를 이용한 검색

역참조는 앞서 일치했던 하위 표현식을 다시 참조할 수 있는 기능이다.

하나의 정규 표현식에서 여러 개의 하위 표현식이 존재할 수 있고,
각 하위 표현식은 임시 버퍼에 차례대로 저장된다. (이게 하위 표현식을 많이 쓰면 부하가 생기는 이유이기도 하다)

역참조는 이들 임시버퍼에 아래와 같은 형식으로 하위 표현식을 다시 참조할 수 있다.
/1
/2
/3
...
/99

즉, /1은 첫번째 하위 표현식을, /3은 세번째 하위 표현식을 참조하는 것이다.
(만약, 하위 표현식을 3개 이상, 그리고 역참조를 3개 이상 해야 할 것 같으면, 다른 방법을 찾아보는 것도 나쁘지 않다.
하위 표현식의 남발은 표현식의 시인성 저하, 성능 저하를 일으키기 때문이다)

그러면, 역참조를 사용하지 않고는 풀 수 없는 예제를 하나 살펴보자.

한 문장이 있고, 이 문장 안에서 반복해 나오는 문자, 바로 실수로 같은 단어를 두 번 입력한 오자를 모두 찾고 싶다고 가정해 보자.
두 단어가 일치하는지 알려면 앞선 단어가 무엇인지 반드시 알고 있어야 한다.

[예문]
This is a block of of text.
Several words here are are
repeated, and and the should not be.

[정규 표현식]
\b(\w+)[ ]\1\b

[결과]
This is a block of of text.
Several words here are are
repeated, and and the should not be.

위에서 사용했던 정규 표현식을 하나씩 까보면...
영숫자, _(언더바)가 1개 이상 일치하는 것을 하위 표현식으로 묶었다.
그리고 하나의 공백을 표시하기 위해 [ ] 집합을 사용하였는데, 지금은 시인성을 높이기 위해 집합을 사용한 것이다.
그리고 앞서 일치한 하위 표현식을 다시 참조하기 위해 /1 역참조 설정
마지막으로 이들을 단어 경계로 찾기 위해 \b...\b로 묶었다.

따라서, and(space)and 가 중복되었음을 인지할 수 있었고, 온전한 단어들로 한정시키기 위해 이들을 단어 경계로 엮은 것이다.
만약, 위 정규 표현식에서 단어 경계(\b...\b)를 빼면 어떻게 될까?

[정규 표현식]
(\w+)[ ]\1

[결과]
This is a block of of text.
Several words here are are
repeated, and and the should not be.

위와 같이 온전한 단어가 아님에도 일치하게 되는 결과가 나오는 것이다.

그러면, 이 문서 초반에 HTML 헤더 태그 예제를 역참조를 이용해 보완시켜 보자.

[정규 표현식]
\<H([1-5])\>.*?\<\/H\1\>

[결과]
<BODY>
<H1>Welcome to my homepage</H1>
Content is divided into four sections:<BR>
<H2>C/C++</H2>
<H3>C#, Python, Lua</H3>
<H4>MSSQL, MySQL, SQLite</H3>
<H5>Unreal Engine3</H5>
1.4 years career for UE3
</BODY>

시작 태그에서 숫자에 해당하는 부분을 하위 표현식으로 묶었고,
종료 태그에서는 일치했던 하위 표현식을 역참조하는 방법을 사용하여,
시작 태그에서의 숫자와 종료 태그의 숫자를 일치시킬 수 있게 되었다.


3. 다양한 역참조 문법

안타깝게도 역참조 문법은 정규 표현식 엔진의 구현에 따라 크게 다르다.
자바 스크립트, 콜드퓨전, vi 에디터 : \1, \2로 표시
펄 : $1, $2로 표시
.NET : match.Groups[1], match.Groups[2]로 표시
VB .NET : match.Groups(1), match.Groups(2)로 표시
PHP : $matches[1], $matched[2]로 표시
자바 : group[1], group[2]로 표시
파이썬 : match_object.groups(), result = m.groups(), result[0], result[2]로 표시
C++ TR1 : match_results<std::basic_string::const_iterator> result[1], result[2]로 표시

위에서 보다시피, 메타 문자를 이용하는 정규 표현식 엔진들과 객체를 이용하는 엔진이 나뉘어진다.
물론 객체를 이용하는 정규 표현식 엔진이 훨씬 더 좋다고 느껴진다.

위에서 나열한 역참조 표시는 모두 상대적 위치를 이용하는 방식들인데, 이 방식에는 심각한 단점이 있다.
하위 표현식을 수정하거나 위치 변경, 추가 삭제 등이 발생해 버리면, 기존의 역참조가 모두 깨지게 된다.
따라서, 하위 표현식에 대해 변경이 발생할 때마다 역참조도 반드시 정확하게 변경시켜 줘야 하는 것이다.

이런 결점을 해결하고자 몇몇 새로운 정규 표현식 엔진들은 '이름 붙여 저장하기' 기능을 지원한다.
각 하위 표현식에 고유한 이름을 주어 상대적인 위치가 아니라, 이 이름으로 하위 표현식을 참조하게 하는 것이다.

.NET이나 파이썬처럼 '이름 붙여 저장하기' 기능을 지원하는 환경을 쓴다면, 이 기능을 쓰는 것을 추천한다.


4. 역참조를 이용한 치환

지금까지 정규 표현식을 이용해 텍스트를 검색하는 것들을 쭈욱 살펴 보았다.
하지만, 정규 표현식으로 강력한 치환 작업 역시 가능하다.

정규 표현식을 사용하여 치환하는 작업은 역참조와 함께 사용하였을 때 그 진가를 발취한다.

아래 예제는 "정규 표현식 - 수량자" 문서에 나온 이메일 주소를 체크하는 예제이다.

[예문]
Please email to SooKkaRak@me.com for urgent stuffs.

[정규 표현식]
\w+[\w\.]*\@\w+[\w\.]*\.[A-Za-z]+

[결과]
Please email to SooKkaRak@me.com for urgent stuffs.

이제 예문의 이메일 주소에 하이퍼 링크를 걸고 싶어졌다.
HTML에서는 <A HREF="mailto:user@address.com">user@address.com</A>의 형식으로 링크를 건다.

그러면 위 예제를 활용해 이메일 주소가 발견되면, 메일을 보낼 수 있도록 링크를 걸어보자.
역참조를 이용하면, 매우 간단하게 치환 작업을 수행할 수 있다.

[예문]
Please email to SooKkaRak@me.com for urgent stuffs.

[정규 표현식]
(\w+[\w\.]*\@\w+[\w\.]*\.[A-Za-z]+)

[치환문]
<A HREF="$1">$1</A>

[결과]
Please email to <A HREF="SooKkaRak@me.com">SooKkaRak@me.com<\A> for urgent stuffs.

치환 작업을 할 때엔 정규 표현식이 2개가 필요하다.
하나는 원하는 부분을 일치시키는 정규 표현식이고,
다른 하나는 일치한 부분을 치환하는데 사용할 정규 표현식이다.

참고로, 위 치환문에서처럼 치환문은 이스케이프를 사용하지 말아야 한다.
만약 검색 정규 표현식과 동일하게 한답시고 이스케이프를 붙여버리면, 해당 이스케이프까지 문자로 고대로 치환될 것이다.

검색 정규 표현식을 자세히 살펴보면, 이메일 주소를 검색하기 위한 정규 표현식을 하위 표현식으로 만들었음을 확인할 수 있다.
그리고, 그 하위 표현식을 $1의 문법으로 역참조하여 치환을 수행한 것이다.

역참조한 것을 검색할 때엔 /1, /2... 역참조한 것을 치환할 때엔 $1, $2...
물론 3. 다양한 역참조 문법에서 보았듯이 자신이 사용하는 정규 표현식 엔진이 역참조를 어떻게 구현하고 있는지 제대로 이해하고 역참조를 이용한 치환 역시 사용해야 할 것이다.

그리고 이 예제에서 보았듯이, 하위 표현식은 역참조를 사용해 필요한 만큼 여러번 참조될 수 있음을 명심하자.

예제를 하나 더 살펴보자.
사용자 정보를 저장하는 데이터베이스에 전화번호가 111-222-3333 형식으로 저장되었다.
하지만, 이 전화번호 형식을 (111) 222-3333으로 변환해야 한다.

[예문]
313-555-1234
248-777-8888
810-555-9000

[정규 표현식]
(\d{3})-(\d{3})-(\d{4})

[치환문]
($1) $2-$3

[결과]
(313) 555-1234
(248) 777-8888
(810) 555-9000

하위 표현식 3개를 사용하였고, 이들을 차례대로 역참조($1, $2, $3)하여 치환하였다.


5. 대소문자 변환

몇몇 정규 표현식 인젠은 다음의 메타 문자들을 활용하여 텍스트를 변환(치환)하도록 지원한다.
\l : 다음에 오는 문자를 소문자로 변환한다
\L ~ \E : 사이의 모든 문자들을 소문자로 변환한다
(Lower)

\u : 다음에 오는 문자를 대문자로 변환한다
\U ~ \E : 사이의 모든 문자들을 대문자로 변환한다
(Upper)

예제를 살펴보면서 감을 잡아보자.
<H1>...</H1> 사이의 모든 문자들을 대문자로 변환해 보자.

[예문]
<BODY>
<H1>Welcome to my homepage</H1>
Content is divided into four sections:<BR>
<H2>C/C++</H2>
<H3>C#, Python, Lua</H3>
<H4>MSSQL, MySQL, SQLite</H3>
<H5>Unreal Engine3</H5>
1.4 years career for UE3
</BODY>

[정규 표현식]
(\<H1\>)(.*?)(\<\/H1\>)

[치환문]
$1\U$2\E$3

[결과]
<BODY>
<H1>WELCOME TO MY HOMEPAGE</H1>
Content is divided into four sections:<BR>
<H2>C/C++</H2>
<H3>C#, Python, Lua</H3>
<H4>MSSQL, MySQL, SQLite</H3>
<H5>Unreal Engine3</H5>
1.4 years career for UE3
</BODY>

정규 표현식에서 (시작 태그)(내용)(종료 태그) 3개의 하위 표현식으로 묶고,
두번째 역참조만 \U$2\E로 대문자로 치환하여 원하는 결과를 얻었다.


6. 정리

하위 표현식은 일치한 부분을 반복해 찾는 작업에 사용할 수도 있고, 
정규 표현식안에서 참조될 수도 있다. 이런 참조를 역참조라고 부른다.

역참조는 텍스트를 검색하고 치환하는 데 매우 유용하다.

안타깝게도 정규 표현식 엔진마다 역참조 문법은 큰 차이가 있으니, 
사용중인 정규 표현식 엔진의 역참조 문법을 제대로 숙지해야 한다.
```
